# Alpha Version of the FLASK DATASTORE GNIB VISA CHECKER! :-{import loggingimport osimport requestsimport jsonimport timeimport mailjet_restimport datetimefrom google.cloud import datastorefrom flask import Flaskfrom flask import requestfrom flask import url_forfrom flask import redirectfrom flask import render_templatefrom requests.packages.urllib3.exceptions import InsecureRequestWarningrequests.packages.urllib3.disable_warnings(InsecureRequestWarning)app = Flask(__name__)# [Constans]MAILJET_API_KEY = os.environ['MAILJET_API_KEY']MAILJET_API_SECRET = os.environ['MAILJET_SECRET_KEY']MAILJET_SENDER = os.environ['MAILJET_SENDER']VISA_RANGE = 25GNIB_RANGE = 25TODAY = datetime.date.today()VISA_UPDATE_URL = 'https://reentryvisa.inis.gov.ie/website/INISOA/IOA.nsf/(getApps4DT)?openagent&dt={}/{}/{}&type=I&num=1'GNIB_UPDATE_URL = 'https://burghquayregistrationoffice.inis.gov.ie/Website/AMSREG/AMSRegWeb.nsf/(getApps4DT)?openagent&dt=' \                  '{}/{}/{}&cat=Work&sbcat=All&typ=Renewal'VISA_HOST = 'reentryvisa.inis.gov.ie'GNIB_HOST = 'burghquayregistrationoffice.inis.gov.ie'HEADERS = {  'user-agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko)  Chrome/52.0.2743.116 Safari/537.36',  'Upgrade-Insecure-Requests': '1',  'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',  'Accept-Language': 'en-US,en;q=0.8,ru;q=0.6,pl;q=0.4,de;q=0.2,uk;q=0.2,it;q=0.2',}# [API objects]datastore_api_client = datastore.Client(os.environ['GCLOUD_PROJECT'])def make_header(header, type):  if type == 'gnib':    header['host'] = 'burghquayregistrationoffice.inis.gov.ie'    return header  elif type == 'visa':    header['host'] = 'reentryvisa.inis.gov.ie'    return header  else:    print 'the host type is not recognized'def send_email(to, subject, body):  client = mailjet_rest.Client(    auth=(MAILJET_API_KEY, MAILJET_API_SECRET))  data = {    'FromEmail': MAILJET_SENDER,    'FromName': 'visa-gnib.info',    'Subject': subject,    'Text-part': body,    'Recipients': [{'Email': to}]  }  result = client.send.create(data=data)@app.route('/')def visa_page():  if request.method == 'GET':    query = datastore_api_client.query(kind='AppointmentSlot', order=('date',))    query.add_filter('type', '=', 'visa')    slots = [str(entity['slot'].strftime("%d-%m-%Y %H:%M")) for entity in query.fetch()]    return render_template('Visa_template.html', template_values=slots)@app.route('/gnib')def gnib_page():  if request.method == 'GET':    query = datastore_api_client.query(kind='AppointmentSlot', order=('slot',))    query.add_filter('type', '=', 'gnib')    slots = [str(entity['slot'].strftime("%d-%m-%Y %H:%M")) for entity in query.fetch()]    return render_template('GNIB_template.html', template_values=slots)@app.route('/notification_request', methods=['GET', 'POST'])def notification_request():  if request.method == 'GET':    return redirect(url_for('visa_page'), 302)  elif request.method == 'POST':    # Create a key for Notification type entity    notification_key = datastore_api_client.key('Notification')    # Create that entity    notification_entity = datastore.entity.Entity(notification_key)    # Add values into entity    notification_entity['email'] = request.form['email']    notification_entity['appt-type'] = request.form['appt-type'].lower()    notification_entity['date_start'] = datetime.datetime.strptime(request.form['date_start'], "%d-%m-%Y")    notification_entity['date_end'] = datetime.datetime.strptime(request.form['date_end'], "%d-%m-%Y")    # Put entity into the datastore    datastore_api_client.put(notification_entity)    # values for the template rendering    template_values = {'email': request.form['email'],                       'appt_type': request.form['appt-type'],                       'date_start': request.form['date_start'],                       'date_end': request.form['date_end'],                       }    return render_template('notification_request_confirmation.html', template_values=template_values)@app.route('/notification_check', methods=['GET'])def notification_check():  # fn that is invoked by the cron job to send notifications about new slots for the notification  if request.method == 'GET':    query = datastore_api_client.query(kind='Notification')    query.keys_only()    query_result_keys = [entity.key for entity in query.fetch()]    for key in query_result_keys:      notification = datastore_api_client.get(key)      query = datastore_api_client.query(kind='AppointmentSlot')      query.add_filter('type', '=', notification['type'].lower())      query.add_filter('slot', '>=', notification['date_start'])      query.add_filter('slot', '<=', notification['date_end'])      list_of_results = [dict(entity) for entity in query.fetch()]      if len(list_of_results) > 0:        # send email        body = "Hi! There are a new appointment slots for {} : \n".format(notification['type'])        for slot in list_of_results:          body += "{}\n".format(slot['slot'])        body += "Register here: {} ".format(VISA_HOST if notification['type'] == "visa" else GNIB_HOST)        send_email(to=notification['email'],                   subject="New {} Appointment".format(notification['type']),                   body=body                   )        # delete the notification object from datastore        datastore_api_client.delete(key)        logging.info('mail send to {}, appointment was deleted'.format(notification['email']))      else:        logging.info('Appointment not found')  return 'OK', 200@app.route('/update')def update():  # expects url :/update_dev?days=20&appt_type=visa  days = int(request.args.get('days'))  appt_type = request.args.get('appt_type')  if request.method == 'GET':    for counter in range(days, GNIB_RANGE + days):      date_obj = datetime.datetime.combine(TODAY + datetime.timedelta(days=counter), datetime.time())      datastore_api_query = datastore_api_client.query(kind='AppointmentSlot')      datastore_api_query.add_filter('appt_type', '=', appt_type)      datastore_api_query.add_filter('date', '=', date_obj)      keys_to_delete = [k.key for k in datastore_api_query.fetch()]      datastore_api_client.delete_multi(keys_to_delete)      # [Request parameters setup]      day = str(date_obj)[8:10]      month = str(date_obj)[5:7]      year = str(date_obj)[0:4]      url = GNIB_UPDATE_URL if appt_type == 'gnib' else VISA_UPDATE_URL      url = url.format(day, month, year)      # make request      response = requests.get(url, headers=make_header(HEADERS, appt_type), verify=False)      response_json = json.loads(response.text)      # processing results      if "empty" not in response.text:        # Slots in the response        slots_of_that_date = list(          set(datetime.datetime.strptime(slot['time'], "%d/%m/%Y %I:%M %p") for slot in response_json["slots"]))        for appt_slot in slots_of_that_date:          appointmentSlot_key = datastore_api_client.key('AppointmentSlot')          appointmentSlot_entity = datastore.entity.Entity(appointmentSlot_key)          appointmentSlot_entity['date'] = date_obj          appointmentSlot_entity['appt_type'] = appt_type          appointmentSlot_entity['slot'] = appt_slot          datastore_api_client.put(appointmentSlot_entity)          # wait for 0.1 sec between each requests - not to ddos :)    time.sleep(0.2)  return 'OK', 200@app.route('/cleanup')def cleanup():  if request.method == 'GET':    # delete all slots which date < today    query = datastore_api_client.query(kind='AppointmentSlot')    query.add_filter('date', '<', datetime.datetime.today())    datastore_api_client.delete_multi([entity.key for entity in query.fetch()])    # get all notif objects where date end < today    query = datastore_api_client.query(kind='Notification')    query.add_filter('date_end', '<', datetime.datetime.today())    query_results = [entity for entity in query.fetch()]    query_results_keys = [ent.key for ent in query_results]    for notification in query_results:      logging.info('slot not found deleting request for {}'.format(notification['email']))      logging.info('date_start = {} date end = '.format(notification['date_start'], notification['date_end']))      send_email(to=notification['email'],                 subject="Your Appointment for {} was not met".format(notification['type']),                 body="Your notification end date ({}) has passed and there were no new appointments. :( \n"                      "We are deleting this request, please feel free for create a new one here: \n"                      "http://visa-gnib.info".format(notification['date_end'])                 )    datastore_api_client.delete_multi(query_results_keys)    # delete old dates    return 'OK', 200@app.errorhandler(500)def server_error(e):  logging.exception('An error occurred during a request.')  return """    An internal error occurred: <pre>{}</pre>    See logs for full stacktrace.    """.format(e), 500@app.errorhandler(404)def page_not_found(error):  return render_template('404.html')if __name__ == '__main__':  # This is used when running locally. Gunicorn is used to run the  # application on Google App Engine. See entrypoint in app.yaml.  app.run(host='127.0.0.1', port=8080, debug=True)# [END app]